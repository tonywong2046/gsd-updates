name: Build & Push Docker to OCIR

# 每次推送到 main 分支时自动构建并推送 Docker 镜像到 OCI Container Registry
# OCI Functions 会自动使用最新镜像（:latest）

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发原因（可选）'
        required: false
        default: '手动重建镜像'

env:
  OCI_REGION: ${{ secrets.OCI_REGION }}                        # 例: ap-singapore-1
  OCI_TENANCY_NAMESPACE: ${{ secrets.OCI_TENANCY_NAMESPACE }}  # OCI 租户命名空间
  IMAGE_NAME: gsd-scripts/gsd-fetcher

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: |
          echo "IMAGE_TAG=${{ env.OCI_REGION }}.ocir.io/${{ env.OCI_TENANCY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_ENV
          echo "IMAGE_TAG_SHA=${{ env.OCI_REGION }}.ocir.io/${{ env.OCI_TENANCY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Login to OCIR
        env:
          OCIR_TOKEN: ${{ secrets.OCI_OCIR_AUTH_TOKEN }}
          OCIR_USER: ${{ env.OCI_TENANCY_NAMESPACE }}/${{ secrets.OCI_USERNAME }}
        run: |
          # 使用 env var 避免特殊字符（> < { # 等）被 shell 误解析
          printf '%s' "$OCIR_TOKEN" | docker login \
            ${{ env.OCI_REGION }}.ocir.io \
            --username "$OCIR_USER" \
            --password-stdin

      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_TAG }} -t ${{ env.IMAGE_TAG_SHA }} .
          echo "✅ 镜像构建完成: ${{ env.IMAGE_TAG }}"

      - name: Push to OCIR
        run: |
          docker push ${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_TAG_SHA }}
          echo "✅ 已推送到 OCIR"

      - name: Summary
        run: |
          echo "## 构建结果" >> $GITHUB_STEP_SUMMARY
          echo "- 镜像: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: \`${{ env.IMAGE_TAG_SHA }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- 触发: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> OCI Functions 将在下次调用时自动使用最新镜像。如需立即生效，请在 OCI Console 手动更新函数配置。" >> $GITHUB_STEP_SUMMARY
