name: Deploy to GCP Cloud Run Functions

on:
  push:
    branches: [ main ]
    paths:
      - 'fetch_jobs.py'
      - 'fetch_journals.py'
      - 'fetch_reports.py'
      - 'main.py'
      - 'requirements.txt'
      - '.github/workflows/deploy-gcp-functions.yml'
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŽŸå› ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨é‡æ–°éƒ¨ç½²'

env:
  PROJECT_ID: gpha-470410
  REGION: asia-southeast1
  RUNTIME: python312
  SERVICE_ACCOUNT: claude-mcp@gpha-470410.iam.gserviceaccount.com
  MEMORY: 512Mi
  TIMEOUT: 540s

jobs:
  deploy:
    name: Deploy Cloud Run Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # æå‰è§£ç  key å¹¶è®¾ç½® GOOGLE_APPLICATION_CREDENTIALSï¼Œ
      # è®© setup-gcloud@v2 ä¸æŠ¥ "not authenticated" Warning
      - name: Prepare GCP credentials
        env:
          GOOGLE_SA: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        run: |
          echo "$GOOGLE_SA" | base64 -d > /tmp/gcp-key.json 2>/dev/null \
            && python3 -c "import json; json.load(open('/tmp/gcp-key.json'))" 2>/dev/null \
            || echo "$GOOGLE_SA" > /tmp/gcp-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Activate GCP service account
        run: |
          SA_EMAIL=$(python3 -c "import json; print(json.load(open('/tmp/gcp-key.json')).get('client_email','UNKNOWN'))")
          echo "ðŸ”‘ Key belongs to SA: $SA_EMAIL"
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          gcloud config set account "$SA_EMAIL"
          gcloud config set project ${{ env.PROJECT_ID }}
          echo "âœ… è®¤è¯å®Œæˆ"
          gcloud auth list
          echo "Active account: $(gcloud config get-value account)"
          echo "Project: $(gcloud config get-value project)"

      # â”€â”€ éƒ¨ç½²ä¸‰ä¸ªå‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Deploy fetch_jobs
        run: |
          gcloud functions deploy fetch-jobs \
            --gen2 \
            --runtime=${{ env.RUNTIME }} \
            --region=${{ env.REGION }} \
            --source=. \
            --entry-point=fetch_jobs_handler \
            --trigger-http \
            --no-allow-unauthenticated \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --memory=${{ env.MEMORY }} \
            --timeout=${{ env.TIMEOUT }} \
            --set-env-vars="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},GEMINI_API_KEY_2=${{ secrets.GEMINI_API_KEY_2 }},GEMINI_API_KEY_3=${{ secrets.GEMINI_API_KEY_3 }},GROQ_API_KEY=${{ secrets.GROQ_API_KEY }},OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}"
          echo "âœ… fetch-jobs éƒ¨ç½²å®Œæˆ"

      - name: Deploy fetch_journals
        run: |
          gcloud functions deploy fetch-journals \
            --gen2 \
            --runtime=${{ env.RUNTIME }} \
            --region=${{ env.REGION }} \
            --source=. \
            --entry-point=fetch_journals_handler \
            --trigger-http \
            --no-allow-unauthenticated \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --memory=${{ env.MEMORY }} \
            --timeout=${{ env.TIMEOUT }} \
            --set-env-vars="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},GEMINI_API_KEY_2=${{ secrets.GEMINI_API_KEY_2 }},GEMINI_API_KEY_3=${{ secrets.GEMINI_API_KEY_3 }},GROQ_API_KEY=${{ secrets.GROQ_API_KEY }},OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}"
          echo "âœ… fetch-journals éƒ¨ç½²å®Œæˆ"

      - name: Deploy fetch_reports
        run: |
          gcloud functions deploy fetch-reports \
            --gen2 \
            --runtime=${{ env.RUNTIME }} \
            --region=${{ env.REGION }} \
            --source=. \
            --entry-point=fetch_reports_handler \
            --trigger-http \
            --no-allow-unauthenticated \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --memory=${{ env.MEMORY }} \
            --timeout=${{ env.TIMEOUT }} \
            --set-env-vars="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},GEMINI_API_KEY_2=${{ secrets.GEMINI_API_KEY_2 }},GEMINI_API_KEY_3=${{ secrets.GEMINI_API_KEY_3 }},GROQ_API_KEY=${{ secrets.GROQ_API_KEY }},OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}"
          echo "âœ… fetch-reports éƒ¨ç½²å®Œæˆ"

      # â”€â”€ æ‰“å°ç»“æžœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Print function URLs
        run: |
          echo "## ðŸš€ éƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for func in fetch-jobs fetch-journals fetch-reports; do
            URL=$(gcloud functions describe $func --gen2 --region=${{ env.REGION }} --format="value(serviceConfig.uri)" 2>/dev/null || echo "èŽ·å–å¤±è´¥")
            echo "- **$func**: \`$URL\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> å‡½æ•°å·²è®¾ä¸º --no-allow-unauthenticatedï¼Œéœ€é€šè¿‡ Cloud Scheduler çš„ OIDC token è°ƒç”¨ã€‚" >> $GITHUB_STEP_SUMMARY
